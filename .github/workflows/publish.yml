name: Publish

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-binaries:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64

    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24.x'
      - name: Build binaries
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: '0'
        run: |
          set -euo pipefail

          binary=showboat
          ext=""
          if [ "$GOOS" = "windows" ]; then
            ext=".exe"
          elif [ "$GOOS" = "js" ] || [ "$GOOS" = "wasip1" ]; then
            ext=".wasm"
          fi

          suffix="$GOOS-$GOARCH"
          if [ -n "$GOARM" ]; then
            suffix="${suffix}v${GOARM}"
          fi

          version="${GITHUB_REF_NAME#v}"
          outdir="dist/${binary}-${suffix}"
          mkdir -p "$outdir"

          env GOOS="$GOOS" GOARCH="$GOARCH" GOARM="$GOARM" CGO_ENABLED=0 \
            go build -trimpath -ldflags "-s -w -X main.version=${version}" -o "$outdir/${binary}${ext}" .

          if [ "$GOOS" = "windows" ]; then
            (cd "$outdir" && zip -9 "../${binary}-${suffix}.zip" "${binary}${ext}")
          else
            tar -C "$outdir" -czf "dist/${binary}-${suffix}.tar.gz" "${binary}${ext}"
          fi
      - name: Check version flag
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        run: |
          set -euo pipefail
          uname -m
          version="${GITHUB_REF_NAME#v}"
          dist_bin="dist/showboat-linux-amd64/showboat"
          "$dist_bin" --version | grep -Fx "$version"
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: showboat-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            dist/*.tar.gz
            dist/*.zip

  release:
    runs-on: ubuntu-latest
    needs: build-binaries
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-wheels:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.24.x'
    - name: Install uv
      uses: astral-sh/setup-uv@v6
    - name: Build wheels
      run: |
        version="${GITHUB_REF_NAME#v}"
        uvx go-to-wheel . \
          --readme README.md \
          --description "Create executable documents that demonstrate an agent's work" \
          --author 'Simon Willison' \
          --license Apache-2.0 \
          --url https://github.com/simonw/showboat \
          --set-version-var main.version \
          --version "$version"
    - name: Store the distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-packages
        path: dist/

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-wheels]
    environment: release
    permissions:
      id-token: write
    steps:
    - name: Download distribution packages
      uses: actions/download-artifact@v4
      with:
        name: python-packages
        path: dist/
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
